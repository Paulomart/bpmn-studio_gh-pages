!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.BpmnJsDiffer={})}(this,function(e){"use strict";var t=Object.prototype.toString,i=Object.prototype.hasOwnProperty;function r(e){return"[object Array]"===t.call(e)}function n(e,t){return i.call(e,t)}function s(e,t){if(null!==(i=e)&&void 0!==i){var i,s=r(e)?o:l;for(var f in e){if(n(e,f))if(!1===t(e[f],s(f)))return}}}function l(e){return e}function o(e){return Number(e)}class f{constructor(e){this.selfOptions=e||{},this.pipes={}}options(e){return e&&(this.selfOptions=e),this.selfOptions}pipe(e,t){let i=t;if("string"==typeof e){if(void 0===i)return this.pipes[e];this.pipes[e]=i}if(e&&e.name){if((i=e).processor===this)return i;this.pipes[i.name]=i}return i.processor=this,i}process(e,t){let i=e;i.options=this.options();let r,n,s=t||e.pipe||"default";for(;s;)void 0!==i.nextAfterChildren&&(i.next=i.nextAfterChildren,i.nextAfterChildren=null),"string"==typeof s&&(s=this.pipe(s)),s.process(i),n=i,r=s,s=null,i&&i.next&&(i=i.next,s=n.nextPipe||i.pipe||r);return i.hasResult?i.result:void 0}}class a{constructor(e){this.name=e,this.filters=[]}process(e){if(!this.processor)throw new Error("add this pipe to a processor before using it");let t=this.debug,i=this.filters.length,r=e;for(let e=0;e<i;e++){let i=this.filters[e];if(t&&this.log(`filter: ${i.filterName}`),i(r),"object"==typeof r&&r.exiting){r.exiting=!1;break}}!r.next&&this.resultCheck&&this.resultCheck(r)}log(e){console.log(`[jsondiffpatch] ${this.name} pipe, ${e}`)}append(...e){return this.filters.push(...e),this}prepend(...e){return this.filters.unshift(...e),this}indexOf(e){if(!e)throw new Error("a filter name is required");for(let t=0;t<this.filters.length;t++){if(this.filters[t].filterName===e)return t}throw new Error(`filter not found: ${e}`)}list(){return this.filters.map(e=>e.filterName)}after(e){let t=this.indexOf(e),i=Array.prototype.slice.call(arguments,1);if(!i.length)throw new Error("a filter is required");return i.unshift(t+1,0),Array.prototype.splice.apply(this.filters,i),this}before(e){let t=this.indexOf(e),i=Array.prototype.slice.call(arguments,1);if(!i.length)throw new Error("a filter is required");return i.unshift(t,0),Array.prototype.splice.apply(this.filters,i),this}replace(e){let t=this.indexOf(e),i=Array.prototype.slice.call(arguments,1);if(!i.length)throw new Error("a filter is required");return i.unshift(t,1),Array.prototype.splice.apply(this.filters,i),this}remove(e){let t=this.indexOf(e);return this.filters.splice(t,1),this}clear(){return this.filters.length=0,this}shouldHaveResult(e){if(!1===e)return void(this.resultCheck=null);if(this.resultCheck)return;let t=this;return this.resultCheck=(e=>{if(!e.hasResult){console.log(e);let i=new Error(`${t.name} failed`);throw i.noResult=!0,i}}),this}}class h{setResult(e){return this.result=e,this.hasResult=!0,this}exit(){return this.exiting=!0,this}switchTo(e,t){return"string"==typeof e||e instanceof a?this.nextPipe=e:(this.next=e,t&&(this.nextPipe=t)),this}push(e,t){return e.parent=this,void 0!==t&&(e.childName=t),e.root=this.root||this,e.options=e.options||this.options,this.children?(this.children[this.children.length-1].next=e,this.children.push(e)):(this.children=[e],this.nextAfterChildren=this.next||null,this.next=e),e.next=this,this}}const u="function"==typeof Array.isArray?Array.isArray:e=>e instanceof Array;function c(e){if("object"!=typeof e)return e;if(null===e)return null;if(u(e))return e.map(c);if(e instanceof Date)return new Date(e.getTime());if(e instanceof RegExp)return function(e){let t=/^\/(.*)\/([gimyu]*)$/.exec(e.toString());return new RegExp(t[1],t[2])}(e);let t={};for(let i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=c(e[i]));return t}class p extends h{constructor(e,t){super(),this.left=e,this.right=t,this.pipe="diff"}setResult(e){if(this.options.cloneDiffValues&&"object"==typeof e){const t="function"==typeof this.options.cloneDiffValues?this.options.cloneDiffValues:c;"object"==typeof e[0]&&(e[0]=t(e[0])),"object"==typeof e[1]&&(e[1]=t(e[1]))}return h.prototype.setResult.apply(this,arguments)}}class d extends h{constructor(e,t){super(),this.left=e,this.delta=t,this.pipe="patch"}}class y extends h{constructor(e){super(),this.delta=e,this.pipe="reverse"}}const m="function"==typeof Array.isArray?Array.isArray:function(e){return e instanceof Array},g=function(e){if(e.left!==e.right)if(void 0!==e.left)if(void 0!==e.right){if("function"==typeof e.left||"function"==typeof e.right)throw new Error("functions are not supported");e.leftType=null===e.left?"null":typeof e.left,e.rightType=null===e.right?"null":typeof e.right,e.leftType===e.rightType&&"boolean"!==e.leftType&&"number"!==e.leftType?("object"===e.leftType&&(e.leftIsArray=m(e.left)),"object"===e.rightType&&(e.rightIsArray=m(e.right)),e.leftIsArray===e.rightIsArray?e.left instanceof RegExp&&(e.right instanceof RegExp?e.setResult([e.left.toString(),e.right.toString()]).exit():e.setResult([e.left,e.right]).exit()):e.setResult([e.left,e.right]).exit()):e.setResult([e.left,e.right]).exit()}else e.setResult([e.left,0,0]).exit();else{if("function"==typeof e.right)throw new Error("functions are not supported");e.setResult([e.right]).exit()}else e.setResult(void 0).exit()};g.filterName="trivial";const x=function(e){if(void 0!==e.delta){if(e.nested=!m(e.delta),!e.nested)if(1!==e.delta.length)if(2!==e.delta.length)3===e.delta.length&&0===e.delta[2]&&e.setResult(void 0).exit();else{if(e.left instanceof RegExp){const t=/^\/(.*)\/([gimyu]+)$/.exec(e.delta[1]);if(t)return void e.setResult(new RegExp(t[1],t[2])).exit()}e.setResult(e.delta[1]).exit()}else e.setResult(e.delta[0]).exit()}else e.setResult(e.left).exit()};x.filterName="trivial";const v=function(e){void 0!==e.delta?(e.nested=!m(e.delta),e.nested||(1!==e.delta.length?2!==e.delta.length?3===e.delta.length&&0===e.delta[2]&&e.setResult([e.delta[0]]).exit():e.setResult([e.delta[1],e.delta[0]]).exit():e.setResult([e.delta[0],0,0]).exit())):e.setResult(e.delta).exit()};function b(e){if(!e||!e.children)return;const t=e.children.length;let i,r=e.result;for(let n=0;n<t;n++)void 0!==(i=e.children[n]).result&&((r=r||{})[i.childName]=i.result);r&&e.leftIsArray&&(r._t="a"),e.setResult(r).exit()}function _(e){if(e.leftIsArray||"object"!==e.leftType)return;let t,i;const r=e.options.propertyFilter;for(t in e.left)Object.prototype.hasOwnProperty.call(e.left,t)&&(r&&!r(t,e)||(i=new p(e.left[t],e.right[t]),e.push(i,t)));for(t in e.right)Object.prototype.hasOwnProperty.call(e.right,t)&&(r&&!r(t,e)||void 0===e.left[t]&&(i=new p(void 0,e.right[t]),e.push(i,t)));e.children&&0!==e.children.length?e.exit():e.setResult(void 0).exit()}v.filterName="trivial",b.filterName="collectChildren",_.filterName="objects";const w=function(e){if(!e.nested)return;if(e.delta._t)return;let t,i;for(t in e.delta)i=new d(e.left[t],e.delta[t]),e.push(i,t);e.exit()};w.filterName="objects";const R=function(e){if(!e||!e.children)return;if(e.delta._t)return;let t,i=e.children.length;for(let r=0;r<i;r++)t=e.children[r],Object.prototype.hasOwnProperty.call(e.left,t.childName)&&void 0===t.result?delete e.left[t.childName]:e.left[t.childName]!==t.result&&(e.left[t.childName]=t.result);e.setResult(e.left).exit()};R.filterName="collectChildren";const N=function(e){if(!e.nested)return;if(e.delta._t)return;let t,i;for(t in e.delta)i=new y(e.delta[t]),e.push(i,t);e.exit()};function A(e){if(!e||!e.children)return;if(e.delta._t)return;let t,i=e.children.length,r={};for(let n=0;n<i;n++)r[(t=e.children[n]).childName]!==t.result&&(r[t.childName]=t.result);e.setResult(r).exit()}N.filterName="objects",A.filterName="collectChildren";const C=function(e,t,i,r){return e[i]===t[r]},j=function(e,t,i,r,n,s){if(0===r||0===n)return{sequence:[],indices1:[],indices2:[]};if(e.match(t,i,r-1,n-1,s)){const l=j(e,t,i,r-1,n-1,s);return l.sequence.push(t[r-1]),l.indices1.push(r-1),l.indices2.push(n-1),l}return e[r][n-1]>e[r-1][n]?j(e,t,i,r,n-1,s):j(e,t,i,r-1,n,s)};var E=function(e,t,i,r){const n=r||{},s=function(e,t,i,r){const n=e.length,s=t.length;let l,o,f=[n+1];for(l=0;l<n+1;l++)for(f[l]=[s+1],o=0;o<s+1;o++)f[l][o]=0;for(f.match=i,l=1;l<n+1;l++)for(o=1;o<s+1;o++)i(e,t,l-1,o-1,r)?f[l][o]=f[l-1][o-1]+1:f[l][o]=Math.max(f[l-1][o],f[l][o-1]);return f}(e,t,i||C,n),l=j(s,e,t,e.length,t.length,n);return"string"==typeof e&&"string"==typeof t&&(l.sequence=l.sequence.join("")),l};const O="function"==typeof Array.isArray?Array.isArray:e=>e instanceof Array,P="function"==typeof Array.prototype.indexOf?(e,t)=>e.indexOf(t):(e,t)=>{let i=e.length;for(let r=0;r<i;r++)if(e[r]===t)return r;return-1};function $(e,t,i,r,n){let s=e[i],l=t[r];if(s===l)return!0;if("object"!=typeof s||"object"!=typeof l)return!1;let o,f,a=n.objectHash;return a?("number"==typeof i?(n.hashCache1=n.hashCache1||[],void 0===(o=n.hashCache1[i])&&(n.hashCache1[i]=o=a(s,i))):o=a(s),void 0!==o&&("number"==typeof r?(n.hashCache2=n.hashCache2||[],void 0===(f=n.hashCache2[r])&&(n.hashCache2[r]=f=a(l,r))):f=a(l),void 0!==f&&o===f)):n.matchByPosition&&i===r}const D=function(e){if(!e.leftIsArray)return;let t,i,r,n,s,l={objectHash:e.options&&e.options.objectHash,matchByPosition:e.options&&e.options.matchByPosition},o=0,f=0,a=e.left,h=e.right,u=a.length,c=h.length;for(u>0&&c>0&&!l.objectHash&&"boolean"!=typeof l.matchByPosition&&(l.matchByPosition=!function(e,t,i,r){for(let n=0;n<i;n++){let i=e[n];for(let e=0;e<r;e++){let r=t[e];if(n!==e&&i===r)return!0}}}(a,h,u,c));o<u&&o<c&&$(a,h,o,o,l);)t=o,n=new p(e.left[t],e.right[t]),e.push(n,t),o++;for(;f+o<u&&f+o<c&&$(a,h,u-1-f,c-1-f,l);)i=u-1-f,r=c-1-f,n=new p(e.left[i],e.right[r]),e.push(n,r),f++;if(o+f===u){if(u===c)return void e.setResult(void 0).exit();for(s=s||{_t:"a"},t=o;t<c-f;t++)s[t]=[h[t]];return void e.setResult(s).exit()}if(o+f===c){for(s=s||{_t:"a"},t=o;t<u-f;t++)s[`_${t}`]=[a[t],0,0];return void e.setResult(s).exit()}delete l.hashCache1,delete l.hashCache2;let d=a.slice(o,u-f),y=h.slice(o,c-f),m=E(d,y,$,l),g=[];for(s=s||{_t:"a"},t=o;t<u-f;t++)P(m.indices1,t-o)<0&&(s[`_${t}`]=[a[t],0,0],g.push(t));let x=!0;e.options&&e.options.arrays&&!1===e.options.arrays.detectMove&&(x=!1);let v=!1;e.options&&e.options.arrays&&e.options.arrays.includeValueOnMove&&(v=!0);let b=g.length;for(t=o;t<c-f;t++){let f=P(m.indices2,t-o);if(f<0){let f=!1;if(x&&b>0)for(let a=0;a<b;a++)if($(d,y,(i=g[a])-o,t-o,l)){s[`_${i}`].splice(1,2,t,3),v||(s[`_${i}`][0]=""),r=t,n=new p(e.left[i],e.right[r]),e.push(n,r),g.splice(a,1),f=!0;break}f||(s[t]=[h[t]])}else i=m.indices1[f]+o,r=m.indices2[f]+o,n=new p(e.left[i],e.right[r]),e.push(n,r)}e.setResult(s).exit()};D.filterName="arrays";let T={numerically:(e,t)=>e-t,numericallyBy:e=>(t,i)=>t[e]-i[e]};const I=function(e){if(!e.nested)return;if("a"!==e.delta._t)return;let t,i,r=e.delta,n=e.left,s=[],l=[],o=[];for(t in r)if("_t"!==t)if("_"===t[0]){if(0!==r[t][2]&&3!==r[t][2])throw new Error("only removal or move can be applied at original array indices,"+` invalid diff type: ${r[t][2]}`);s.push(parseInt(t.slice(1),10))}else 1===r[t].length?l.push({index:parseInt(t,10),value:r[t][0]}):o.push({index:parseInt(t,10),delta:r[t]});for(t=(s=s.sort(T.numerically)).length-1;t>=0;t--){let e=r[`_${i=s[t]}`],o=n.splice(i,1)[0];3===e[2]&&l.push({index:e[1],value:o})}let f=(l=l.sort(T.numericallyBy("index"))).length;for(t=0;t<f;t++){let e=l[t];n.splice(e.index,0,e.value)}let a,h=o.length;if(h>0)for(t=0;t<h;t++){let i=o[t];a=new d(e.left[i.index],i.delta),e.push(a,i.index)}e.children?e.exit():e.setResult(e.left).exit()};I.filterName="arrays";const B=function(e){if(!e||!e.children)return;if("a"!==e.delta._t)return;let t,i=e.children.length;for(let r=0;r<i;r++)t=e.children[r],e.left[t.childName]=t.result;e.setResult(e.left).exit()};B.filterName="arraysCollectChildren";const q=function(e){if(!e.nested)return void(3===e.delta[2]&&(e.newName=`_${e.delta[1]}`,e.setResult([e.delta[0],parseInt(e.childName.substr(1),10),3]).exit()));if("a"!==e.delta._t)return;let t,i;for(t in e.delta)"_t"!==t&&(i=new y(e.delta[t]),e.push(i,t));e.exit()};q.filterName="arrays";let H=(e,t,i)=>{if("string"==typeof t&&"_"===t[0])return parseInt(t.substr(1),10);if(O(i)&&0===i[2])return`_${t}`;let r=+t;for(let i in e){let n=e[i];if(O(n))if(3===n[2]){let e=parseInt(i.substr(1),10),s=n[1];if(s===+t)return e;e<=r&&s>r?r++:e>=r&&s<r&&r--}else if(0===n[2]){parseInt(i.substr(1),10)<=r&&r++}else 1===n.length&&i<=r&&r--}return r};function k(e){if(!e||!e.children)return;if("a"!==e.delta._t)return;let t,i=e.children.length,r={_t:"a"};for(let n=0;n<i;n++){let i=(t=e.children[n]).newName;void 0===i&&(i=H(e.delta,t.childName,t.result)),r[i]!==t.result&&(r[i]=t.result)}e.setResult(r).exit()}k.filterName="arraysCollectChildren";const M=function(e){e.left instanceof Date?(e.right instanceof Date?e.left.getTime()!==e.right.getTime()?e.setResult([e.left,e.right]):e.setResult(void 0):e.setResult([e.left,e.right]),e.exit()):e.right instanceof Date&&e.setResult([e.left,e.right]).exit()};M.filterName="dates";let S=null,F=function(e){if(!S){let t;if("undefined"!=typeof diff_match_patch&&(t="function"==typeof diff_match_patch?new diff_match_patch:new diff_match_patch.diff_match_patch),!t){if(!e)return null;let t=new Error("text diff_match_patch library not found");throw t.diff_match_patch_not_found=!0,t}S={diff:function(e,i){return t.patch_toText(t.patch_make(e,i))},patch:function(e,i){let r=t.patch_apply(t.patch_fromText(i),e);for(let e=0;e<r[1].length;e++)if(!r[1][e]){new Error("text patch failed").textPatchFailed=!0}return r[0]}}}return S};const V=function(e){if("string"!==e.leftType)return;let t=e.options&&e.options.textDiff&&e.options.textDiff.minLength||60;if(e.left.length<t||e.right.length<t)return void e.setResult([e.left,e.right]).exit();let i=F();if(!i)return void e.setResult([e.left,e.right]).exit();let r=i.diff;e.setResult([r(e.left,e.right),0,2]).exit()};V.filterName="texts";const J=function(e){if(e.nested)return;if(2!==e.delta[2])return;const t=F(!0).patch;e.setResult(t(e.left,e.delta[0])).exit()};J.filterName="texts";const L=function(e){e.nested||2===e.delta[2]&&e.setResult([function(e){let t,i,r,n,s,l=null;const o=/^@@ +-(\d+),(\d+) +\+(\d+),(\d+) +@@$/;let f;for(t=0,i=(r=e.split("\n")).length;t<i;t++){let e=(n=r[t]).slice(0,1);"@"===e?(l=o.exec(n),r[f=t]="@@ -"+l[3]+","+l[4]+" +"+l[1]+","+l[2]+" @@"):"+"===e?(r[t]="-"+r[t].slice(1),"+"===r[t-1].slice(0,1)&&(s=r[t],r[t]=r[t-1],r[t-1]=s)):"-"===e&&(r[t]="+"+r[t].slice(1))}return r.join("\n")}(e.delta[0]),0,2]).exit()};L.filterName="texts";function z(e,t){return e.$instanceOf(t)}function G(e,t){return t.some(function(t){return z(e,t)})}function K(e){return G(e,["bpmndi:BPMNEdge","bpmndi:BPMNShape"])}function Q(e){return!z(e,"bpmn:DataObject")&&(z(e,"bpmn:Process")?function(e){var t=e.$parent.rootElements.find(function(e){return z(e,"bpmn:Collaboration")});if(!t)return{element:e,property:""};var i=t.participants.find(function(t){return t.processRef===e});return i&&{element:i,property:"processRef."}}(e):G(e,["bpmn:Participant","bpmn:Collaboration","bpmn:FlowElement","bpmn:SequenceFlow","bpmn:MessageFlow","bpmn:Participant","bpmn:Lane","bpmn:DataAssociation"])?{element:e,property:""}:void 0)}function U(){this._layoutChanged={},this._changed={},this._removed={},this._added={}}function W(){}U.prototype.removed=function(e,t,i,r){var n;(n=Q(i))?this._removed[n.element.id]||(this._removed[n.element.id]=i):(n=Q(e))?this.changed(n.element,n.property+t+"["+r+"]",null,i):K(e)&&"waypoint"===t&&(this._layoutChanged[e.bpmnElement.id]=e.bpmnElement)},U.prototype.changed=function(e,t,i,r){var n;if(K(e))this._layoutChanged[e.bpmnElement.id]=e.bpmnElement;else if(n=Q(e)){var s=this._changed[n.element.id];s||(s=this._changed[n.element.id]={model:e,attrs:{}}),void 0===r&&void 0===i||(s.attrs[t]={oldValue:r,newValue:i})}},U.prototype.added=function(e,t,i,r){var n;(n=Q(i))?this._added[n.element.id]||(this._added[n.element.id]=i):(n=Q(e))?this.changed(n.element,n.property+t+"["+r+"]",i,null):K(e)&&"waypoint"===t&&(this._layoutChanged[e.bpmnElement.id]=e.bpmnElement)},U.prototype.moved=function(e,t,i,r){},W.prototype.createDiff=function(e,t){return new class{constructor(e){this.processor=new f(e),this.processor.pipe(new a("diff").append(b,g,M,V,_,D).shouldHaveResult()),this.processor.pipe(new a("patch").append(R,B,x,J,w,I).shouldHaveResult()),this.processor.pipe(new a("reverse").append(A,k,v,L,N,q).shouldHaveResult())}options(...e){return this.processor.options(...e)}diff(e,t){return this.processor.process(new p(e,t))}patch(e,t){return this.processor.process(new d(e,t))}reverse(e){return this.processor.process(new y(e))}unpatch(e,t){return this.patch(e,this.reverse(t))}clone(e){return c(e)}}({objectHash:function(e){return e.id||JSON.stringify(e)},propertyFilter:function(e,t){return"$instanceOf"!==e}}).diff(e,t)},W.prototype.diff=function(e,t,i){return i=i||new U,function e(t,n){s(t,function(t,l){var o,f,a;"a"!==t._t&&r(t)&&r(t[0])&&(o=t[0],f=function(e,i,r){return e[(3===t.length?"_":"")+r]=[i],e},a={_t:"a"},s(o,function(e,t){a=f(a,e,t)}),t=a),"a"===t._t?s(t,function(t,s){if("_t"!==s){var o=/^_/.test(s),f=!o&&r(t),a=o&&""===t[0];s=parseInt(o?s.slice(1):s,10),f||o&&!a?i[o?"removed":"added"](n,l,t[0],s):a?i.moved(n,l,t[1],t[2]):e(t,n[l][s])}}):r(t)?i.changed(n,l,t[0],t[1]):(i.changed(n,l),e(t,n[l]))})}(this.createDiff(e,t),t),i},e.Differ=W,e.diff=function(e,t,i){return(new W).diff(e,t,i)},Object.defineProperty(e,"__esModule",{value:!0})});
